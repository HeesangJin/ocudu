#
# Copyright 2021-2026 Software Radio Systems Limited
#
# By using this file, you agree to the terms and conditions set
# forth in the LICENSE file which can be found at the top level of
# the distribution.
#

include:
  - project: ocudu/ocudu_packaging
    ref: "main"
    file: .gitlab/ci-shared/package.yml
  - local: .gitlab/ci-shared/build.yml
  - local: .gitlab/ci-shared/docker.yml

variables:
  OCUDU_PACKAGING_REGISTRY_URI: ${CI_REGISTRY}/ocudu/ocudu_packaging

################
# Build caches #
################

.cache_build_get: &cache_build_get
  - key: ${OS}-${COMPILER}-${CMAKE_BUILD_TYPE}-${MARCH}
    paths: [ccache]
    policy: pull-push

#################
# Template jobs #
#################

# Base job

.build_and_unit:
  extends: .build_and_unit_template
  stage: build and unit tests
  needs:
    - job: trigger builder
      optional: true
      artifacts: false
  variables:
    TEST_EXECUTION_TIMEOUT: 0
  script:
    - &script_functions |
      build_ocudu_extended() {
        target="$1"
        build_ocudu
        if [[ -n "$OUTPUT_FINGERPRINT" ]]; then
          echo "Storing fingerprints of all executables to $OUTPUT_FINGERPRINT"
          cd ${OCUDU_BUILD_DIR}
          /usr/local/builder_tools/bin/python /usr/local/bin/changed_tests.py -b . -o "../$OUTPUT_FINGERPRINT"
          cd ..
        fi
      }

      launch_tests() {
        cd ${CI_PROJECT_DIR}/${OCUDU_BUILD_DIR}
        if [ -n "${FINGERPRINT}" ]; then
          echo "Searching for changed tests"
          CTEST_SUBSET=$(/usr/local/builder_tools/bin/python /usr/local/bin/changed_tests.py -b . -i "../${FINGERPRINT}" -d md5)
          if [ -n "${CTEST_SUBSET}" ]; then
            echo "Tests with changed fingerprint: ${CTEST_SUBSET}"
            CTEST_SUBSET_CMD="-I 0,0,0,${CTEST_SUBSET}"
          else
            echo "No tests changed"
            ret=0
            exit $ret
          fi
        fi
        echo "Using LD_LIBRARY_PATH=$LD_LIBRARY_PATH"
        CTEST_CMD="ctest -j${CPU_JOBS} ${CTEST_SUBSET_CMD} $CTEST_ARGS --schedule-random --output-on-failure --output-junit xunit.xml"
        echo "+ ${CTEST_CMD}"

        status_file=$(mktemp)
        timeout ${TEST_EXECUTION_TIMEOUT} \
          bash -c "${CTEST_CMD}; echo \$? > ${status_file}" \
          && ret=$(cat ${status_file}) || ret=124

        if [[ $TEST_MODE = "coverage" ]]; then
          common_options="-j${CPU_JOBS} \
            --exclude-unreachable-branches \
            --gcov-ignore-parse-errors=negative_hits.warn_once_per_file \
            --exclude=${CI_PROJECT_DIR}/tests/* \
            --exclude=${CI_PROJECT_DIR}/apps/* \
            --exclude=${CI_PROJECT_DIR}/external/* \
            --exclude=${CI_PROJECT_DIR}/include/ocudu/asn1/e1ap/.* \
            --exclude=${CI_PROJECT_DIR}/include/ocudu/asn1/e2ap/.* \
            --exclude=${CI_PROJECT_DIR}/include/ocudu/asn1/f1ap/.* \
            --exclude=${CI_PROJECT_DIR}/include/ocudu/asn1/ngap/.* \
            --exclude=${CI_PROJECT_DIR}/include/ocudu/asn1/nrppa/.* \
            --exclude=${CI_PROJECT_DIR}/include/ocudu/asn1/rrc_nr/.* \
            --exclude=${CI_PROJECT_DIR}/include/ocudu/asn1/xnap/.* \
            --exclude=${CI_PROJECT_DIR}/lib/asn1/e1ap/.* \
            --exclude=${CI_PROJECT_DIR}/lib/asn1/e2ap/.* \
            --exclude=${CI_PROJECT_DIR}/lib/asn1/f1ap/.* \
            --exclude=${CI_PROJECT_DIR}/lib/asn1/ngap/.* \
            --exclude=${CI_PROJECT_DIR}/lib/asn1/nrppa/.* \
            --exclude=${CI_PROJECT_DIR}/lib/asn1/rrc_nr/.* \
            --exclude=${CI_PROJECT_DIR}/lib/asn1/xnap/.* \
            --exclude-lines-by-pattern \".*ocudu_assert.*|.*ocudu_sanity_check.*\" \
            --root=${CI_PROJECT_DIR} \
            --gcov-ignore-parse-errors=all \
            --merge-mode-functions=merge-use-line-min"

          echo "+ gcovr: Coverage generation"
          if ! output=$(gcovr $common_options --keep 2>&1); then
            echo "gcovr FAILED!"
          fi

          if ! output=$(gcovr $common_options --xml --print-summary --use-gcov-files --keep \
            --exclude="${CI_PROJECT_DIR}/lib/phy/.*" \
            --exclude="${CI_PROJECT_DIR}/lib/scheduler/.*" \
            -o coverage_1.xml 2>&1); then
            echo "gcovr coverage_1.xml FAILED!"
            echo "$output"
            ret=1
          fi

          if ! output=$(gcovr $common_options --xml --print-summary --use-gcov-files --keep \
            --filter="${CI_PROJECT_DIR}/lib/phy/.*" \
            --filter="${CI_PROJECT_DIR}/lib/scheduler/.*" \
            -o coverage_2.xml 2>&1); then
            echo "gcovr coverage_2.xml FAILED!"
            echo "$output"
            ret=1
          fi

          echo "Generated coverage files:"
          ls -lh coverage*.xml 2>/dev/null || true

          # Check that no coverage file exceeds 10MB GitLab limit
          maxsize=$((10*1024*1024))
          for covfile in coverage*.xml; do
            if [ -f "$covfile" ]; then
              filesize=$(stat -c%s "$covfile")
              if (( filesize > maxsize )); then
                echo "ERROR: $covfile is $(( filesize / 1024 / 1024 ))MB, exceeds 10MB GitLab limit!"
                ret=1
              fi
            fi
          done
        fi

        if [ $ret -eq 124 ]; then
          echo "The test execution exceeded the maximum allowed time !!!!"
        fi

        exit $ret
      }

    - build_ocudu_extended
    - launch_tests
  timeout: 3 hours
  after_script:
    - mv ${CI_PROJECT_DIR}/${OCUDU_BUILD_DIR}/coverage_1.xml   ${CI_PROJECT_DIR}/${CI_JOB_ID}_coverage_1.xml   || true
    - mv ${CI_PROJECT_DIR}/${OCUDU_BUILD_DIR}/coverage_2.xml   ${CI_PROJECT_DIR}/${CI_JOB_ID}_coverage_2.xml   || true
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: ${CI_JOB_ID}_coverage*.xml
    paths:
      - ${CI_JOB_ID}_coverage*.xml
      - ${OCUDU_BUILD_DIR}/Testing/Temporary/MemoryChecker.*.log
    expire_in: 5 days

# Basic builds (MR and update cache on Nightly)

.smoke coverage:
  extends: .build_and_unit
  variables:
    OS: ubuntu-24.04
    COMPILER: gcc
    CMAKE_BUILD_TYPE: Release
    ASSERT_LEVEL: PARANOID
    ENABLE_FFTW: "True"
    TEST_MODE: coverage
    ENABLE_GCOV: "True"
    MARCH: x86-64-v3
    LINKER: mold
  tags: [saas-linux-medium-amd64]

.smoke relwithdeb:
  extends: .build_and_unit
  variables:
    OS: ubuntu-24.04
    COMPILER: clang
    CMAKE_BUILD_TYPE: RelWithDebInfo
    ASSERT_LEVEL: PARANOID
    ENABLE_FFTW: "True"
    TEST_MODE: default
    MARCH: x86-64-v3
    LINKER: mold
  tags: [saas-linux-medium-amd64]

.smoke tsan:
  extends: .build_and_unit
  variables:
    OS: ubuntu-25.10
    COMPILER: clang
    CMAKE_BUILD_TYPE: Debug
    ASSERT_LEVEL: PARANOID
    ENABLE_FFTW: "True"
    ENABLE_TSAN: "True"
    TEST_MODE: tsan
    MARCH: x86-64-v3
    LINKER: mold
  tags: [saas-linux-medium-amd64]

.smoke archlinux:
  extends: .build_and_unit
  variables:
    OS: archlinux-latest
    ENABLE_WERROR: "False"
    COMPILER: gcc
    CMAKE_BUILD_TYPE: Debug
    ASSERT_LEVEL: PARANOID
    ENABLE_FFTW: "True"
    TEST_MODE: default
    MARCH: x86-64-v3
  tags: [saas-linux-medium-amd64]

.smoke dpdk:
  extends: .build_and_unit
  variables:
    OS: ubuntu-22.04
    COMPILER: gcc
    CMAKE_BUILD_TYPE: Release
    ENABLE_UHD: "False"
    ENABLE_ZEROMQ: "False"
    ENABLE_DPDK: "True"
    ASSERT_LEVEL: PARANOID
    ENABLE_FFTW: "True"
    DPDK_VERSION: "24.11.2_avx2"
    MARCH: x86-64-v3
    LINKER: mold
  tags: [saas-linux-medium-amd64]

.smoke valgrind:
  extends: .build_and_unit
  variables:
    OS: ubuntu-24.04
    COMPILER: gcc
    CMAKE_BUILD_TYPE: Debug
    ASSERT_LEVEL: PARANOID
    ENABLE_FFTW: "True"
    TEST_MODE: valgrind
    MARCH: x86-64-v3
    LINKER: lld
  tags: [saas-linux-medium-amd64]

.smoke printers:
  extends: .build_and_unit
  variables: &gdb_printers_variables
    OS: ubuntu-24.04
    OCUDU_TARGET: pretty_printer_tests
    COMPILER: gcc
    CMAKE_BUILD_TYPE: Debug
    ASSERT_LEVEL: PARANOID
    ENABLE_FFTW: "True"
    TEST_GDB_PRINTERS: "True"
    TEST_MODE: pretty_printers
    MARCH: x86-64-v3
  tags: [saas-linux-medium-amd64]

# Combinations to use in schedules matrix

.combinations: &basic_combinations
  COMPILER: [gcc, clang]
  CMAKE_BUILD_TYPE: [Release, RelWithDebInfo, Debug]
  ASSERT_LEVEL: [NONE, NORMAL, PARANOID]

######
# MR #
######

# Smoke builds in PR: with or without cache

smoke relwithdeb cached:
  extends: .smoke relwithdeb
  rules:
    - if: $CI_MERGE_REQUEST_LABELS =~ /ci-no-cache/
      when: never
    - if: $ON_MR
  cache:
    - *cache_build_get

smoke tsan cached:
  extends: .smoke tsan
  rules:
    - if: $CI_MERGE_REQUEST_LABELS =~ /ci-no-cache/
      when: never
    - if: $ON_MR
  cache:
    - *cache_build_get

smoke archlinux cached:
  extends: .smoke archlinux
  rules:
    - if: $CI_MERGE_REQUEST_LABELS =~ /ci-no-cache/
      when: never
    - if: $ON_MR
      allow_failure: false
  cache:
    - *cache_build_get

smoke dpdk cached:
  extends: .smoke dpdk
  rules:
    - if: $CI_MERGE_REQUEST_LABELS =~ /ci-no-cache/
      when: never
    - if: $ON_MR
  cache:
    - *cache_build_get

smoke pretty printers cached:
  extends: .smoke printers
  rules:
    - if: $CI_MERGE_REQUEST_LABELS =~ /ci-no-cache/
      when: never
    - if: $ON_MR
      changes: &gdb_printers_changes
        paths:
          - include/ocudu/adt/**/*
          - tests/utils/gdb/pretty_printers/*
          - utils/gdb/**/*
          - .gdbinit
  cache:
    - *cache_build_get

smoke relwithdeb clean:
  extends: .smoke relwithdeb
  rules:
    - if: $CI_MERGE_REQUEST_LABELS =~ /ci-no-cache/

smoke tsan clean:
  extends: .smoke tsan
  rules:
    - if: $CI_MERGE_REQUEST_LABELS =~ /ci-no-cache/

smoke archlinux clean:
  extends: .smoke archlinux
  rules:
    - if: $CI_MERGE_REQUEST_LABELS =~ /ci-no-cache/

smoke dpdk clean:
  extends: .smoke dpdk
  rules:
    - if: $CI_MERGE_REQUEST_LABELS =~ /ci-no-cache/

smoke pretty printers clean:
  extends: .smoke printers
  rules:
    - if: $CI_MERGE_REQUEST_LABELS =~ /ci-no-cache/
      changes:
        <<: *gdb_printers_changes

# Intermediate commits

intermediate commits cached:
  extends: .smoke coverage
  rules:
    - if: $CI_MERGE_REQUEST_LABELS =~ /ci-no-cache/
      when: never
    - if: $ON_MR
  script:
    - *script_functions
    - &fetch_branches |
      git config advice.detachedHead false
      if [ "$CI_MERGE_REQUEST_SOURCE_PROJECT_PATH" != "$CI_PROJECT_PATH" ]; then
        git remote add fork $CI_MERGE_REQUEST_SOURCE_PROJECT_URL
        git fetch --deepen=50 origin $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
        git fetch --deepen=50 fork $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
        git branch $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME fork/$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
        git branch $CI_MERGE_REQUEST_TARGET_BRANCH_NAME origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME
      else
        git fetch --deepen=50 origin $CI_MERGE_REQUEST_TARGET_BRANCH_NAME $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
        git branch $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME origin/$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
        git branch $CI_MERGE_REQUEST_TARGET_BRANCH_NAME origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME
      fi
      FORK_POINT=$(git merge-base $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME $CI_MERGE_REQUEST_TARGET_BRANCH_NAME)
      SOURCE_SHA=${CI_MERGE_REQUEST_SOURCE_BRANCH_SHA:-$CI_COMMIT_SHA}
    - |
      for rev in $(git rev-list --reverse $FORK_POINT..$SOURCE_SHA)
      do
        echo "##################################################"
        echo "#### $rev ####"
        echo "##################################################"
        git checkout $rev
        if ! git log -1 --format=%B "$rev" | grep -qiE '^Signed-off-by:\s+.+\s+<.+>$'; then
          echo "âœ— Missing Signed-off-by trailer in commit."
          git log -1 --oneline "$rev"
          exit 1
        fi
        build_ocudu_extended
      done
    - launch_tests
  cache:
    - *cache_build_get

valgrind changed tests:
  extends: .smoke valgrind
  allow_failure:
    exit_codes: 124 # timeout command's exit code when the time is reached
  rules:
    - if: $CI_MERGE_REQUEST_LABELS =~ /ci-no-memcheck/
      when: never
    - if: $ON_MR
  variables:
    CLEAN_BUILD: "False"
    FINGERPRINT: "fingerprints.csv"
    TEST_EXECUTION_TIMEOUT: 20m
  script:
    - *script_functions
    - *fetch_branches
    - |
      echo "##################################################"
      echo "#### $FORK_POINT ####"
      echo "##################################################"
      git checkout $FORK_POINT
      OUTPUT_FINGERPRINT="${FINGERPRINT}"
      build_ocudu_extended
      OUTPUT_FINGERPRINT=""
    - |
      echo "##################################################"
      echo "#### $SOURCE_SHA ####"
      echo "##################################################"
      git checkout $SOURCE_SHA
      build_ocudu_extended
    - echo "This test execution has a timeout of ${TEST_EXECUTION_TIMEOUT}. If the execution excess that timer, the job will be marked as allowed_to_fail. This will avoid the job to have a huge duration in a MR pipeline."
    - launch_tests
  cache:
    - *cache_build_get

intermediate commits clean:
  extends: intermediate commits cached
  rules:
    - if: $CI_MERGE_REQUEST_LABELS =~ /ci-no-cache/

#################
# Build Nightly #
#################
smoke coverage:
  extends: .smoke coverage
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Nightly/
    - if: $ON_PROTECTED_BRANCH
  tags: [saas-linux-large-amd64]

smoke asan:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Nightly/
  variables:
    OS: ubuntu-24.04
    COMPILER: clang
    CMAKE_BUILD_TYPE: Debug
    ASSERT_LEVEL: PARANOID
    ENABLE_ASAN: "True"
    MARCH: x86-64-v3
  tags: [saas-linux-large-amd64]

smoke rtsan:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Nightly/
  variables:
    OS: ubuntu-24.04-rtsan
    COMPILER: clang
    CMAKE_BUILD_TYPE: Debug
    ASSERT_LEVEL: PARANOID
    ENABLE_RTSAN: "True"
    ENABLE_WERROR: "False"
    TEST_MODE: rtsan
    MARCH: x86-64-v3
  tags: [saas-linux-large-amd64]

# Packaging

package:
  extends: .deb-package
  stage: build and unit tests
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Nightly/
      when: delayed
      start_in: 45 minutes
  variables:
    PROJECT_NAME: ocudu
    RELEASE_VERSION: "99.9"
    KUBERNETES_CPU_REQUEST: ${SRS_CPU_LIMIT}
    KUBERNETES_CPU_LIMIT: ${SRS_CPU_LIMIT}
    KUBERNETES_MEMORY_REQUEST: ${SRS_MEMORY_LIMIT}
    KUBERNETES_MEMORY_LIMIT: ${SRS_MEMORY_LIMIT}
    extraopts: -DMARCH=x86-64-v3
  tags: [saas-linux-large-amd64]
  before_script:
    - |
      CPU_JOBS="${KUBERNETES_CPU_LIMIT:-$(nproc 2>/dev/null || getconf _NPROCESSORS_ONLN 2>/dev/null || echo 1)}"
      export CPU_JOBS
      export MAKEFLAGS="-j${CPU_JOBS}"
      export DEB_BUILD_OPTIONS="parallel=${CPU_JOBS}"
  parallel:
    matrix:
      - OS_VERSION: "22.04"
      - OS_VERSION: "24.04"
      - OS_VERSION: "25.04"
      # - OS_VERSION: "25.10"             # disabled, see comment below
      # Since version 20251007 of Ubuntu 25.10 a Rust implementation of coreutils (rust-coreutils and coreutils-from-uutils)
      # is used instead of the traditional version from GNU (coreutils-from-gnu). A bug in the Rust coreutils
      # causes a permission error during startup of the container (as the packing is run as unprivileged user).
  needs: []

install-package:
  extends: .deb-install
  stage: build and unit tests
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Nightly/
  variables:
    PROJECT_NAME: ocudu
    RELEASE_VERSION: "99.9"
  tags: [saas-linux-medium-amd64]
  script:
    - gnb --version
  parallel:
    matrix:
      - OS_VERSION: "22.04"
      - OS_VERSION: "24.04"
      - OS_VERSION: "25.04"
      # - OS_VERSION: "25.10"             # disabled, see comment above
  needs:
    - package

# Validate export on, enabled for test vector generation

export on amd64:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Nightly/
      when: delayed
      start_in: 30 minutes
  interruptible: false
  variables:
    COMPILER: gcc
    TEST_MODE: none
    ENABLE_EXPORT: "True"
  tags: [saas-linux-large-amd64]
  parallel:
    matrix:
      - OS: [ubuntu-25.10, ubuntu-24.04, ubuntu-22.04]
      - OS: [ubuntu-25.10, ubuntu-24.04, ubuntu-22.04]
        MARCH: x86-64-v3

export on amd64 avx512:
  extends: export on amd64
  variables:
    TEST_MODE: full
  tags: [saas-linux-large-amd64, avx512, sctp]
  parallel:
    matrix:
      - OS: [ubuntu-25.10, ubuntu-24.04, ubuntu-22.04]
        MARCH: x86-64-v4

# Build + unit tests combinations

ubuntu-25.04 amd64 avx2:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Nightly/
      when: delayed
      start_in: 60 minutes
  interruptible: false
  variables:
    OS: ubuntu-25.04
    MARCH: x86-64-v3
  tags: [saas-linux-large-amd64]
  parallel:
    matrix:
      - <<: *basic_combinations

ubuntu-25.10 amd64 avx2:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Nightly/
      when: delayed
      start_in: 60 minutes
  interruptible: false
  variables:
    OS: ubuntu-25.10
    MARCH: x86-64-v3
  tags: [saas-linux-large-amd64]
  parallel:
    matrix:
      - <<: *basic_combinations

ubuntu-24.04 amd64 avx2:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Nightly/
      when: delayed
      start_in: 90 minutes
  interruptible: false
  variables:
    OS: ubuntu-24.04
    MARCH: x86-64-v3
  tags: [saas-linux-large-amd64]
  parallel:
    matrix:
      - <<: *basic_combinations
      - <<: *basic_combinations
        ENABLE_FFTW: "False"
        ENABLE_MKL: "True"

ubuntu-24.04 amd64 avx512:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Nightly/
      when: delayed
      start_in: 90 minutes
  interruptible: false
  variables:
    OS: ubuntu-24.04
    MARCH: x86-64-v4
    TEST_MODE: full
  tags: [saas-linux-large-amd64, avx512, sctp]
  parallel:
    matrix:
      - <<: *basic_combinations
      - <<: *basic_combinations
        ENABLE_FFTW: "False"
        ENABLE_MKL: "True"

ubuntu-22.04 amd64 avx2:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Nightly/
      when: delayed
      start_in: 90 minutes
  interruptible: false
  variables:
    OS: ubuntu-22.04
    MARCH: x86-64-v3
  tags: [saas-linux-large-amd64]
  parallel:
    matrix:
      - <<: *basic_combinations

# Basic ARM NO_ISA / NEON

ubuntu-24.04 arm neon:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Nightly/
      when: delayed
      start_in: 30 minutes
  interruptible: false
  variables:
    OS: ubuntu-24.04
    MARCH: armv8.2-a+crypto+fp16+dotprod
  tags: [saas-linux-large-arm64]
  parallel:
    matrix:
      - <<: *basic_combinations
      - <<: *basic_combinations
        ENABLE_FFTW: "False"
        ENABLE_ARMPL: "True"

# Basic DPDK

ubuntu dpdk:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Nightly/
      when: delayed
      start_in: 120 minutes
  interruptible: false
  variables:
    ENABLE_UHD: "False"
    ENABLE_ZEROMQ: "False"
    ENABLE_DPDK: "True"
    ASSERT_LEVEL: PARANOID
    MARCH: x86-64-v3
  tags: [saas-linux-large-amd64]
  parallel:
    matrix:
      - OS: ubuntu-25.10
        COMPILER: [gcc, clang]
        DPDK_VERSION: ["24.11.2_avx2"]
      - OS: ubuntu-25.04
        COMPILER: [gcc, clang]
        DPDK_VERSION: ["24.11.2_avx2"]
      - OS: ubuntu-24.04
        COMPILER: [gcc, clang]
        DPDK_VERSION: ["23.11.4_avx2", "24.11.2_avx2"]
      - OS: ubuntu-22.04
        COMPILER: [gcc, clang]
        DPDK_VERSION: ["22.11.8_avx2", "23.11.4_avx2", "24.11.2_avx2"]

# Nightly Sanitizers

ubsan avx2:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Nightly/
      when: delayed
      start_in: 120 minutes
  variables:
    OS: ubuntu-25.04
    COMPILER: gcc
    CMAKE_BUILD_TYPE: Debug
    ASSERT_LEVEL: PARANOID
    ENABLE_UBSAN: "True"
    GTEST_DISCOVERY_TIMEOUT: 120
    TEST_MODE: default
    MARCH: x86-64-v3
  tags: [saas-linux-large-amd64]

###################
# Alternative OSs #
###################
archlinux amd64 avx2:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Alternative OSs/
      when: delayed
      start_in: 30 minutes
  interruptible: false
  variables:
    OS: archlinux-latest
    ENABLE_WERROR: "False"
    MARCH: x86-64-v3
  tags: [saas-linux-large-amd64]
  parallel:
    matrix:
      - <<: *basic_combinations

archlinux amd64 avx512:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Alternative OSs/
  interruptible: false
  variables:
    OS: archlinux-latest
    ENABLE_WERROR: "False"
    MARCH: x86-64-v4
    TEST_MODE: full
  tags: [saas-linux-large-amd64, avx512, sctp]
  parallel:
    matrix:
      - <<: *basic_combinations

debian 12 amd64 avx2:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Alternative OSs/
      when: delayed
      start_in: 90 minutes
  interruptible: false
  variables:
    OS: debian-12
    ENABLE_WERROR: "False"
    MARCH: x86-64-v3
  tags: [saas-linux-large-amd64]
  parallel:
    matrix:
      - <<: *basic_combinations

debian 12 amd64 avx512:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Alternative OSs/
      when: delayed
      start_in: 30 minutes
  interruptible: false
  variables:
    OS: debian-12
    ENABLE_WERROR: "False"
    MARCH: x86-64-v4
    TEST_MODE: full
  tags: [saas-linux-large-amd64, avx512, sctp]
  parallel:
    matrix:
      - <<: *basic_combinations

debian 13 amd64 avx2:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Alternative OSs/
      when: delayed
      start_in: 150 minutes
  interruptible: false
  variables:
    OS: debian-13
    ENABLE_WERROR: "False"
    MARCH: x86-64-v3
  tags: [saas-linux-large-amd64]
  parallel:
    matrix:
      - <<: *basic_combinations

debian 13 amd64 avx512:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Alternative OSs/
      when: delayed
      start_in: 90 minutes
  interruptible: false
  variables:
    OS: debian-13
    ENABLE_WERROR: "False"
    MARCH: x86-64-v4
    TEST_MODE: full
  tags: [saas-linux-large-amd64, avx512, sctp]
  parallel:
    matrix:
      - <<: *basic_combinations

##########
# Weekly #
##########

check builders ubuntu versions:
  extends: .check image exists for all supported ubuntu versions
  stage: static
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Weekly/
      when: delayed
      start_in: 15 minutes
  variables:
    VERSIONS_TO_IGNORE: "20.04"
  script:
    - check_if_image_exists ${CI_REGISTRY_IMAGE}/builder-ubuntu- :${DOCKER_BUILDER_VERSION}

# Sanitizers

.weekly sanitizers:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Weekly/
      when: delayed
      start_in: 30 minutes
  interruptible: false
  variables:
    ASSERT_LEVEL: PARANOID
    CMAKE_BUILD_TYPE: Debug

sanitizers amd64 avx2:
  extends: .weekly sanitizers
  variables:
    MARCH: x86-64-v3
  tags: [saas-linux-large-amd64]
  parallel:
    matrix:
      # ubuntu-22.04 disabled due to https://github.com/google/sanitizers/issues/1259#issuecomment-642312392
      # TSAN Ubuntu 24.04 disabled - TSAN requires an ASLR config of 28 bits (instead of 32 bit as is by default on Ubuntu 24.04)
      - OS: [ubuntu-25.10]
        SANITIZER: tsan
        COMPILER: [gcc, clang]
        ENABLE_TSAN: "True"
        TEST_MODE: default
      - OS: [ubuntu-25.10, ubuntu-24.04]
        SANITIZER: asan
        COMPILER: clang
        ENABLE_ASAN: "True"
        TEST_MODE: default
      - OS: [ubuntu-25.10, ubuntu-24.04]
        SANITIZER: valgrind
        COMPILER: gcc
        TEST_MODE: valgrind
      - OS: [ubuntu-25.10, ubuntu-24.04]
        SANITIZER: ubsan
        COMPILER: [gcc, clang]
        ENABLE_UBSAN: "True"
        GTEST_DISCOVERY_TIMEOUT: 120
        TEST_MODE: default

sanitizers amd64 avx512:
  extends: .weekly sanitizers
  variables:
    MARCH: x86-64-v4
  tags: [saas-linux-large-amd64, avx512, sctp]
  parallel:
    matrix:
      # ubuntu-22.04 disabled due to https://github.com/google/sanitizers/issues/1259#issuecomment-642312392
      - OS: [ubuntu-25.10, ubuntu-24.04]
        SANITIZER: tsan
        COMPILER: [gcc, clang]
        ENABLE_TSAN: "True"
        TEST_MODE: full
      - OS: [ubuntu-25.10, ubuntu-24.04]
        SANITIZER: asan
        COMPILER: clang
        ENABLE_ASAN: "True"
        TEST_MODE: full
      # Valgrind doesn't support AVX512 instruction set
      - OS: [ubuntu-25.10, ubuntu-24.04]
        SANITIZER: ubsan
        COMPILER: [gcc, clang]
        ENABLE_UBSAN: "True"
        GTEST_DISCOVERY_TIMEOUT: 120
        TEST_MODE: full

sanitizers arm neon:
  extends: .weekly sanitizers
  tags: [saas-linux-large-arm64]
  variables:
    MARCH: armv8.2-a+crypto+fp16+dotprod
  parallel:
    matrix:
      # ubuntu-22.04 disabled due to https://github.com/google/sanitizers/issues/1259#issuecomment-642312392
      - OS: [ubuntu-25.10, ubuntu-24.04]
        SANITIZER: tsan
        COMPILER: [gcc, clang]
        ENABLE_TSAN: "True"
        TEST_MODE: default
      - OS: [ubuntu-25.10, ubuntu-24.04]
        SANITIZER: asan
        COMPILER: clang
        ENABLE_ASAN: "True"
        TEST_MODE: default
      - OS: [ubuntu-25.10, ubuntu-24.04]
        SANITIZER: valgrind
        COMPILER: gcc
        TEST_MODE: valgrind
      - OS: [ubuntu-25.10, ubuntu-24.04]
        SANITIZER: ubsan
        COMPILER: [gcc, clang]
        ENABLE_UBSAN: "True"
        GTEST_DISCOVERY_TIMEOUT: 120
        TEST_MODE: default

# UHD Alternatives

build uhd alt:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Weekly/
      when: delayed
      start_in: 15 minutes
  interruptible: false
  variables:
    TEST_MODE: none
    ASSERT_LEVEL: PARANOID
    MARCH: x86-64-v3
  tags: [saas-linux-large-amd64]
  parallel:
    matrix:
      - OS: [ubuntu-25.10]
        COMPILER: [gcc, clang]
        UHD_VERSION: ["4.8.0.0"]
      - OS: [ubuntu-25.04]
        COMPILER: [gcc, clang]
        UHD_VERSION: ["4.8.0.0", "4.7.0.0"]
      - OS: ubuntu-24.04
        COMPILER: [gcc, clang]
        UHD_VERSION: ["4.8.0.0", "4.7.0.0", "4.6.0.0"]
      - OS: ubuntu-22.04
        COMPILER: [gcc, clang]
        UHD_VERSION:
          ["4.8.0.0", "4.7.0.0", "4.6.0.0", "4.4.0.0", "4.3.0.0", "4.1.0.5"]

# Validate test gdb pretty printers

gdb pretty printers:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Weekly/
      when: delayed
      start_in: 300 minutes
  interruptible: false
  variables:
    <<: *gdb_printers_variables
  tags: [saas-linux-large-amd64]

# Build + unit tests combinations

ubuntu-25.04 amd64 avx512:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Weekly/
      when: delayed
      start_in: 430 minutes
  interruptible: false
  variables:
    OS: ubuntu-25.04
    MARCH: x86-64-v4
    TEST_MODE: full
  tags: [saas-linux-large-amd64, avx512, sctp]
  parallel:
    matrix:
      - <<: *basic_combinations

ubuntu-25.04 arm neon:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Weekly/
      when: delayed
      start_in: 430 minutes
  interruptible: false
  variables:
    OS: ubuntu-25.04
    MARCH: armv8.2-a+crypto+fp16+dotprod
  tags: [saas-linux-large-arm64]
  parallel:
    matrix:
      - <<: *basic_combinations

ubuntu-25.10 amd64 native:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Weekly/
      when: delayed
      start_in: 30 minutes
  interruptible: false
  variables:
    OS: ubuntu-25.10
  tags: [saas-linux-large-amd64]
  parallel:
    matrix:
      - <<: *basic_combinations

ubuntu-25.10 amd64 avx512:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Weekly/
      when: delayed
      start_in: 30 minutes
  interruptible: false
  variables:
    OS: ubuntu-25.10
    MARCH: x86-64-v4
    TEST_MODE: full
  tags: [saas-linux-large-amd64, avx512, sctp]
  parallel:
    matrix:
      - <<: *basic_combinations

ubuntu-25.10 arm native:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Weekly/
      when: delayed
      start_in: 30 minutes
  interruptible: false
  variables:
    OS: ubuntu-25.10
  tags: [saas-linux-large-arm64]
  parallel:
    matrix:
      - <<: *basic_combinations

ubuntu-25.10 arm neon:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Weekly/
      when: delayed
      start_in: 30 minutes
  interruptible: false
  variables:
    OS: ubuntu-25.10
    MARCH: armv8.2-a+crypto+fp16+dotprod
  tags: [saas-linux-large-arm64]
  parallel:
    matrix:
      - <<: *basic_combinations

ubuntu-24.04 amd64 native:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Alternative OSs/
      when: delayed
      start_in: 60 minutes
  interruptible: false
  variables:
    OS: ubuntu-24.04
  tags: [saas-linux-large-amd64]
  parallel:
    matrix:
      - <<: *basic_combinations
      - <<: *basic_combinations
        ENABLE_FFTW: "False"
        ENABLE_MKL: "True"

ubuntu-24.04 amd64 avx:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Weekly/
      when: delayed
      start_in: 400 minutes
  interruptible: false
  variables:
    OS: ubuntu-24.04
    MARCH: x86-64-v2
  tags: [saas-linux-large-amd64]
  parallel:
    matrix:
      - <<: *basic_combinations
      - <<: *basic_combinations
        ENABLE_FFTW: "False"
        ENABLE_MKL: "True"

ubuntu-24.04 amd64 avx512 TRACE:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Weekly/
      when: delayed
      start_in: 400 minutes
  interruptible: false
  variables:
    OS: ubuntu-24.04
    MARCH: x86-64-v4
    CXXFLAGS: -D OCUDU_L2_TRACE -D OCUDU_L1_TRACE -D OCUDU_L2_LATE_TRACE -D OCUDU_OFH_TRACE -D OCUDU_UP_TRACE
    TEST_MODE: full
  tags: [saas-linux-large-amd64, avx512, sctp]
  parallel:
    matrix:
      - <<: *basic_combinations
      - <<: *basic_combinations
        ENABLE_FFTW: "False"
        ENABLE_MKL: "True"

ubuntu-24.04 arm native:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Alternative OSs/
      when: delayed
      start_in: 60 minutes
  interruptible: false
  variables:
    OS: ubuntu-24.04
  tags: [saas-linux-large-arm64]
  parallel:
    matrix:
      - <<: *basic_combinations
      - <<: *basic_combinations
        ENABLE_FFTW: "False"
        ENABLE_ARMPL: "True"

ubuntu-22.04 amd64 avx512:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Alternative OSs/
      when: delayed
      start_in: 120 minutes
  interruptible: false
  variables:
    OS: ubuntu-22.04
    MARCH: x86-64-v4
    TEST_MODE: full
  tags: [saas-linux-large-amd64, avx512, sctp]
  parallel:
    matrix:
      - <<: *basic_combinations

ubuntu-22.04 arm neon:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Alternative OSs/
      when: delayed
      start_in: 120 minutes
  interruptible: false
  variables:
    OS: ubuntu-22.04
    MARCH: armv8.2-a+crypto+fp16+dotprod
  tags: [saas-linux-large-arm64]
  parallel:
    matrix:
      - <<: *basic_combinations

# DPDK

.dpdk_combinations: &basic_combinations_dpdk
  <<: *basic_combinations
  ENABLE_UHD: "False"
  ENABLE_ZEROMQ: "False"
  ENABLE_DPDK: "True"
  COMPILER: [gcc, clang]

ubuntu-22.04 amd64 avx2 dpdk:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Alternative OSs/
      when: delayed
      start_in: 210 minutes
  interruptible: false
  variables:
    OS: ubuntu-22.04
    MARCH: x86-64-v3
  tags: [saas-linux-large-amd64]
  parallel:
    matrix:
      - <<: *basic_combinations_dpdk
        DPDK_VERSION: ["22.11.8_avx2", "23.11.4_avx2", "24.11.2_avx2"]

ubuntu-22.04 amd64 avx512 dpdk:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Alternative OSs/
      when: delayed
      start_in: 240 minutes
  interruptible: false
  variables:
    OS: ubuntu-22.04
    MARCH: x86-64-v4
    TEST_MODE: full
  tags: [saas-linux-large-amd64, avx512, sctp]
  parallel:
    matrix:
      - <<: *basic_combinations_dpdk
        DPDK_VERSION: ["22.11.8_avx512", "23.11.4_avx512", "24.11.2_avx512"]

ubuntu-24.04 amd64 avx2 dpdk:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Weekly/
      when: delayed
      start_in: 270 minutes
  interruptible: false
  variables:
    OS: ubuntu-24.04
    MARCH: x86-64-v3
  tags: [saas-linux-large-amd64]
  parallel:
    matrix:
      - <<: *basic_combinations_dpdk
        DPDK_VERSION: "23.11.4_avx2"
      - <<: *basic_combinations
        DPDK_VERSION: "23.11.4_avx2"
        ENABLE_FFTW: "False"
        ENABLE_MKL: "True"
      - <<: *basic_combinations_dpdk
        DPDK_VERSION: "24.11.2_avx2"
      - <<: *basic_combinations
        DPDK_VERSION: "24.11.2_avx2"
        ENABLE_FFTW: "False"
        ENABLE_MKL: "True"

ubuntu-24.04 amd64 avx512 dpdk:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Weekly/
      when: delayed
      start_in: 320 minutes
  interruptible: false
  variables:
    OS: ubuntu-24.04
    MARCH: x86-64-v4
    TEST_MODE: full
  tags: [saas-linux-large-amd64, avx512, sctp]
  parallel:
    matrix:
      - <<: *basic_combinations_dpdk
        DPDK_VERSION: "23.11.4_avx512"
      - <<: *basic_combinations
        DPDK_VERSION: "23.11.4_avx512"
        ENABLE_FFTW: "False"
        ENABLE_MKL: "True"
      - <<: *basic_combinations_dpdk
        DPDK_VERSION: "24.11.2_avx512"
      - <<: *basic_combinations
        DPDK_VERSION: "24.11.2_avx512"
        ENABLE_FFTW: "False"
        ENABLE_MKL: "True"

ubuntu-25.10 amd64 avx2 dpdk:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Weekly/
      when: delayed
      start_in: 360 minutes
  interruptible: false
  variables:
    OS: ubuntu-25.10
    MARCH: x86-64-v3
  tags: [saas-linux-large-amd64]
  parallel:
    matrix:
      - <<: *basic_combinations_dpdk
        DPDK_VERSION: "24.11.2_avx2"

ubuntu-25.10 amd64 avx512 dpdk:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Weekly/
      when: delayed
      start_in: 360 minutes
  interruptible: false
  variables:
    OS: ubuntu-25.10
    MARCH: x86-64-v4
    TEST_MODE: full
  tags: [saas-linux-large-amd64, avx512, sctp]
  parallel:
    matrix:
      - <<: *basic_combinations_dpdk
        DPDK_VERSION: "24.11.2_avx512"

ubuntu-25.04 amd64 avx2 dpdk:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Alternative OSs/
      when: delayed
      start_in: 460 minutes
  interruptible: false
  variables:
    OS: ubuntu-25.04
    MARCH: x86-64-v3
  tags: [saas-linux-large-amd64]
  parallel:
    matrix:
      - <<: *basic_combinations_dpdk
        DPDK_VERSION: "24.11.2_avx2"

ubuntu-25.04 amd64 avx512 dpdk:
  extends: .build_and_unit
  rules:
    - if: $CI_PIPELINE_SCHEDULE_DESCRIPTION =~ /Alternative OSs/
      when: delayed
      start_in: 460 minutes
  interruptible: false
  variables:
    OS: ubuntu-25.04
    MARCH: x86-64-v4
    TEST_MODE: full
  tags: [saas-linux-large-amd64, avx512, sctp]
  parallel:
    matrix:
      - <<: *basic_combinations_dpdk
        DPDK_VERSION: "24.11.2_avx512"
