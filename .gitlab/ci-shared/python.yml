#
# Copyright 2021-2026 Software Radio Systems Limited
#
# By using this file, you agree to the terms and conditions set
# forth in the LICENSE file which can be found at the top level of
# the distribution.
#

.parallel-python-versions:
  parallel: &matrix-python-version
    matrix:
      - PYTHON_VERSION: ["3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]

.python_base:
  image: python:${PYTHON_VERSION}-alpine # sh entrypoint
  variables:
    PYTHON_VERSION: "3.14"
    TWINE_USERNAME: "gitlab-ci-token"
    TWINE_PASSWORD: "$CI_JOB_TOKEN"
    TWINE_REPO: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi"

.python_publish:
  extends: .python_base
  rules:
    - if: $ON_DEFAULT_BRANCH
    - if: $ON_MR
      when: manual
      allow_failure: true

# Tools

.tox:
  extends: .python_base
  rules:
    - if: $ON_MR
  script:
    - &setup_env_variables |
      export PIP_EXTRA_INDEX_URL="https://${TWINE_USERNAME}:${TWINE_PASSWORD}@${TWINE_REPO#https://}/simple"
    - pip install 'tox<5'
    - cd $PY_DIR
    - tox -r
  parallel: *matrix-python-version

.publish deps:
  extends: .python_publish
  script:
    - *setup_env_variables
    - pip install twine
    - cd $PY_DIR
    - pip install .
    - find /root/.cache/pip/ -iname "*.whl" -exec python -m twine upload --verbose --disable-progress-bar --repository-url ${TWINE_REPO} {} \;
  parallel: *matrix-python-version

.publish wheel:
  # cibuildwheel is a tool that builds your wheel for multiple platforms
  # and python versions using pypa docker images
  # Doc: https://cibuildwheel.readthedocs.io/en/stable/
  # Gitlab Integration: https://cibuildwheel.readthedocs.io/en/stable/setup/#gitlab-ci
  extends: .python_publish
  image: ubuntu:22.04
  variables:
    CIBW_ENVIRONMENT_PASS_LINUX: ""
    # See https://github.com/docker-library/docker/pull/166
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  services:
    - name: docker:20.10.15-dind
      alias: docker
      entrypoint: ["env", "-u", "DOCKER_HOST"]
      command: ["dockerd-entrypoint.sh"]
  script:
    - *setup_env_variables
    # Install tools
    - DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y --no-install-recommends curl apt-transport-https ca-certificates python3-pip python3-venv
    - pip install cibuildwheel build twine
    # Build sdist and check if already uploaded to the repo
    - cd $PY_DIR
    - python3 -m build --sdist
    - |
      file=$(ls dist/*.tar.gz)
      file="${file#*/}"
      file="${file/.tar.gz/}"
      VERSION="${file#*-}"
      PY_LIB_NAME="${file%%-*}"
    # Exit 0 if already exists
    - (pip index versions ${PY_LIB_NAME} --extra-index-url ${PIP_EXTRA_INDEX_URL} | grep "$VERSION") && exit 0 || true
    # If it's a new package/version, setup cibuildwheel and run it. If it's a pure python wheel, run build instead.
    - curl -sSL https://get.docker.com/ | sh
    - cibuildwheel --platform linux --output-dir dist || python3 -m build --wheel
    # Upload generated wheels & sdist
    - twine upload --verbose --disable-progress-bar --repository-url ${TWINE_REPO} dist/*
